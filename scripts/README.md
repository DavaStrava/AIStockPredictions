# Portfolio Import Scripts

Scripts for importing portfolio data from brokerage exports (currently supporting Merrill Lynch).

## Prerequisites

- Node.js 18+
- PostgreSQL database configured (see main README)
- Environment variables in `.env.local`

## Scripts Overview

### 1. `reconcile-portfolio.ts`

Analyzes transaction history and current holdings to calculate initial positions and prepare data for import.

**Usage:**
```bash
npx tsx scripts/reconcile-portfolio.ts <transactions.csv> <holdings.csv> [output.json]
```

**Arguments:**
| Argument | Required | Description |
|----------|----------|-------------|
| `transactions.csv` | Yes | Path to Merrill Lynch transaction history CSV |
| `holdings.csv` | Yes | Path to Merrill Lynch current holdings CSV |
| `output.json` | No | Output path (default: `./portfolio-import-data.json`) |

**Example:**
```bash
npx tsx scripts/reconcile-portfolio.ts ~/Desktop/transactions.csv ~/Desktop/holdings.csv
```

**Output:**
- Reconciliation report showing per-symbol analysis
- Cash flow analysis (deposits, withdrawals, dividends, buys, sells)
- ROI calculation
- JSON file with transactions, initial holdings, and summary

### 2. `import-merrill-portfolio.ts`

Imports the reconciled portfolio data into the database.

**Usage:**
```bash
npx tsx scripts/import-merrill-portfolio.ts <path-to-import-data.json>
```

**Arguments:**
| Argument | Required | Description |
|----------|----------|-------------|
| `import-data.json` | Yes | Path to JSON file generated by `reconcile-portfolio.ts` |

**Example:**
```bash
npx tsx scripts/import-merrill-portfolio.ts ./portfolio-import-data.json
```

**What it does:**
1. Creates a new portfolio (or uses existing default portfolio)
2. Clears existing holdings/transactions if portfolio exists
3. Imports initial holdings as BUY transactions (dated before transaction history)
4. Imports all transactions chronologically
5. Verifies import against reference values

### 3. `parse-merrill-transactions.ts`

Low-level utility for parsing Merrill Lynch transaction CSV format.

## Complete Workflow

### Step 1: Export from Merrill Lynch

1. Log into Merrill Lynch
2. Export **Transaction History** (CSV format)
3. Export **Current Holdings/Positions** (CSV format)

### Step 2: Reconcile Data

```bash
npx tsx scripts/reconcile-portfolio.ts \
  ~/Downloads/TransactionHistory.csv \
  ~/Downloads/CurrentPositions.csv \
  ./my-portfolio-data.json
```

Review the output to verify:
- Holdings reconciliation (current qty vs. transaction net)
- Cash balance calculations
- Any discrepancies

### Step 3: Import to Database

```bash
npx tsx scripts/import-merrill-portfolio.ts ./my-portfolio-data.json
```

### Step 4: Verify in App

Open the application and check:
- Portfolio summary matches expected values
- All holdings appear correctly
- Transaction history is complete

## Supported CSV Formats

### Merrill Lynch Transaction History

Expected columns:
- `Trade Date` - Transaction date (MM/DD/YYYY)
- `Settlement Date` - Settlement date
- `Description` - Transaction description (e.g., "Purchase", "Sale", "Dividend")
- `Type` - Transaction type code
- `Symbol/ CUSIP` - Stock symbol or CUSIP
- `Quantity` - Number of shares
- `Price` - Price per share
- `Amount` - Total transaction amount

### Merrill Lynch Holdings

Expected structure:
- Row 8: Portfolio total value
- Row 12+: Individual holdings with columns for symbol, description, quantity, cost basis, price, value, unrealized gain/loss
- Balances section: Money market accounts and cash balance

## Troubleshooting

### "File not found" error
- Use absolute paths or `~` for home directory
- Verify the file exists: `ls -la ~/Desktop/file.csv`

### "Invalid import data format" error
- Ensure you're using the JSON file from `reconcile-portfolio.ts`, not raw CSV
- Check the JSON structure matches expected format

### Holdings don't match
- Review the reconciliation report for discrepancies
- Check for corporate actions (stock splits, mergers) not captured in transaction history
- Manual adjustments may be needed for positions held before transaction history

### Database connection errors
- Verify `.env.local` has correct `DATABASE_URL`
- Run `npm run db:health` to check connectivity

## Data Validation

The import process validates:
- Transaction types: `BUY`, `SELL`, `DEPOSIT`, `WITHDRAW`, `DIVIDEND`
- Required fields per transaction type
- Numeric values (quantity, price, amount)
- Date formats
- Symbol format (1-10 alphanumeric characters)

Security limits:
- Maximum 10,000 transactions per import
- Maximum 500 characters for notes
- Maximum 10 characters for symbols

## API Alternative

For programmatic imports, use the REST API:

```bash
POST /api/portfolios/{id}/transactions/import
Content-Type: application/json

{
  "transactions": [
    {
      "transactionType": "BUY",
      "symbol": "AAPL",
      "quantity": 10,
      "pricePerShare": 150.00,
      "totalAmount": 1500.00,
      "fees": 0,
      "transactionDate": "2024-01-15T00:00:00.000Z",
      "notes": "Optional note"
    }
  ]
}
```

Response:
```json
{
  "success": true,
  "imported": 1,
  "failed": 0,
  "errors": []
}
```
