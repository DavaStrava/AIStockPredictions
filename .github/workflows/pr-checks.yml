name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-quality:
    name: Pull Request Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better diffs

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: üîç API Contract Tests (Breaking Change Detection)
        run: |
          echo "Running contract tests to prevent breaking changes..."
          npm run test:contracts
        continue-on-error: false

      - name: üìä Test Coverage
        run: |
          npm run test:coverage || true
          echo "Coverage report generated"

      - name: üèóÔ∏è Build Check
        run: |
          echo "Verifying build succeeds..."
          npm run build

      - name: üìù Test Summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Contract tests passed - No breaking changes detected" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Build succeeded" >> $GITHUB_STEP_SUMMARY

  api-changes-check:
    name: API Changes Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for API route changes
        id: api-changes
        run: |
          # Check if any API routes were modified
          API_CHANGES=$(git diff --name-only origin/main...HEAD | grep -E "src/app/api/.*route\.ts" || true)

          if [ -n "$API_CHANGES" ]; then
            echo "api_changed=true" >> $GITHUB_OUTPUT
            echo "## ‚ö†Ô∏è API Routes Modified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following API routes were changed:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$API_CHANGES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Ensure contract tests pass to prevent breaking changes." >> $GITHUB_STEP_SUMMARY
          else
            echo "api_changed=false" >> $GITHUB_OUTPUT
            echo "## ‚úÖ No API Changes" >> $GITHUB_STEP_SUMMARY
            echo "No API routes were modified in this PR." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Setup Node.js
        if: steps.api-changes.outputs.api_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        if: steps.api-changes.outputs.api_changed == 'true'
        run: npm ci

      - name: Run API contract tests
        if: steps.api-changes.outputs.api_changed == 'true'
        run: |
          echo "API routes changed - running contract tests..."
          npm run test:contracts

      - name: Comment PR with API changes
        if: steps.api-changes.outputs.api_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## üîç API Changes Detected\n\nThis PR modifies API routes. Contract tests have been run to ensure no breaking changes.\n\n**Please verify:**\n- [ ] Response structures are unchanged\n- [ ] All tests pass\n- [ ] Documentation is updated if needed'
            })
